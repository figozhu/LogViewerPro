# 开发进度（LogViewer Pro）

> 基于《需求与实现方案.md》v1.2，所有任务均围绕 Electron + Vue 3 技术栈展开；状态更新时请同步备注，确保可在中断后快速恢复。

## 状态约定
- **未开始**：尚未着手。
- **进行中**：正在开发或联调。
- **已完成**：开发、联调、自测全部通过。
- **阻塞**：受依赖或环境限制暂无法推进，需在备注中写明原因。

## 任务列表

### 0. 项目基建与发布
| 编号 | 任务 | 描述 | 优先级 | 状态 | 备注 |
| --- | --- | --- | --- | --- | --- |
| B-01 | 初始化工程骨架 | 使用 Electron + Vite + Vue 3 + TypeScript，划分主进程、渲染进程、Worker 目录并配置热重载 | 高 | 已完成 | Electron-Vite + Vue3 骨架建立，含 Pinia 注入、IPC 验证与 Worker watch 机制 |
| B-02 | 开发体验与规范 | 配置 TypeScript 别名、ESLint、Prettier、lint-staged，并建立统一的提交校验流程 | 中 | 已完成 | ESLint+Prettier+lint-staged+Husky 已落地，提供 `npm run lint/format` |
| B-03 | 打包与发布流程 | 基于 electron-builder 配置 Windows/macOS/Linux 单文件打包，满足 NFR-2 的跨平台要求 | 高 | 已完成 | 新增 electron-builder 配置、`npm run dist` 脚本，支持多平台打包产物到 `release/` |
| B-04 | CI/CD 管线 | 建立自动化流水线：安装依赖→单测→E2E→多平台打包→产物上传 | 中 | 已完成 | 添加 GitHub Actions（lint/typecheck/dist），输出各平台打包产物为 artifact |

### 1. 主进程与 IPC
| 编号 | 任务 | 描述 | 优先级 | 状态 | 备注 |
| --- | --- | --- | --- | --- | --- |
| M-01 | 主进程启动框架 | 创建 BrowserWindow、启用 contextIsolation、注册菜单与快捷键，确保主进程只做协调 | 高 | 已完成 | 完成菜单模板、帮助入口与全局快捷键，支持菜单事件下发至 Renderer |
| M-02 | IPC 通道实现 | 按 TDD 2.4 实现 `templates:*`、`dialog:openFile`、`index:*`、`schema:get`、`query:run`、`filters:getOptions` 等 handler | 高 | 已完成 | 主进程完成模板 CRUD、文件对话框以及索引任务的 IPC 入口与转发 |
| M-03 | Worker 生命周期管理 | 在主进程中负责 worker_threads 的创建、重启、错误冒泡与消息转发 | 高 | 已完成 | 新增 WorkerManager，支持自动重启、错误转发与指令队列化 sendCommand 接口 |
| M-04 | 全局错误与日志 | 捕获未处理异常/拒绝、记录日志并通过对话框或通知反馈给用户 | 中 | 已完成 | 引入 Logger + 全局错误处理，支持日志落盘、对话框提示与 Renderer 错误广播 |

### 2. 模板管理（FR-1）
| 编号 | 任务 | 描述 | 优先级 | 状态 | 备注 |
| --- | --- | --- | --- | --- | --- |
| T-01 | `LogTemplate` 模型与校验 | 定义模板字段、校验命名捕获组、强制选择时间字段与 FTS 字段 | 高 | 已完成 | 新增 validator，强制校验命名捕获组、关键字段与正则合法性 |
| T-02 | `electron-store` 持久化 | 将模板集合存储在 `config.json`，含版本迁移、去重、导入/导出能力 | 高 | 已完成 | TemplateStore 支持版本迁移、名称去重、导入/导出与覆盖策略 |
| T-03 | 模板管理界面 | 在 Vue 中实现模板列表、创建、编辑、删除、搜索等 CRUD 能力 | 高 | 已完成 | 新增 TemplateManager 组件，内置列表、编辑表单与 IPC 调用 |
| T-04 | 正则测试工具 | 提供示例日志输入区、实时匹配结果与字段预览，满足 FR-1.3 | 中 | 已完成 | Regex 测试面板支持样本输入、命名组预览与高亮 |
| T-05 | 模板选取流程 | 在打开日志时展示模板选择器，并持久化“最近使用的模板”映射 | 中 | 已完成 | Renderer 端提供模板选择 prompt + 最近记录列表，Main 端持久化 recentItems |

### 3. 文件处理与缓存（FR-2, NFR-3/4/5）
| 编号 | 任务 | 描述 | 优先级 | 状态 | 备注 |
| --- | --- | --- | --- | --- | --- |
| F-01 | 文件选择与拖拽 | 支持菜单、对话框与拖拽打开日志，校验路径、只读权限与文件大小 | 高 | 已完成 | 菜单 & 拖拽统一到 `handleExternalFileOpen`，主进程校验路径并报错提示 |
| F-02 | 最近文件列表 | 记录最近打开的文件及其模板，提供快速入口与删除能力 | 中 | 已完成 | RecentItemsStore + UI 列表，可一键重新打开并自动选择模板 |
| F-03 | 索引缓存命名 | 依据 `filePath + template.regex` 计算 MD5，生成 `userData/index_cache/<hash>.db` | 高 | 已完成 | IndexCacheManager 生成 md5+db/meta，并在 Worker Job 中传递 |
| F-04 | 缓存校验与跳过 | 根据文件 `mtime` 判断是否复用缓存，满足 FR-2.4/2.5 | 高 | 已完成 | 支持 mtime 比较，命中时主进程直接广播 `index:complete` |
| F-05 | 缓存清理功能 | 实现“清除所有索引缓存”按钮，并支持单个缓存失效与错误处理 | 高 | 已完成 | Renderer 提供清除按钮，IndexCacheManager 清理目录并返回占用信息 |
| F-06 | 索引进度控制 | 提供可取消的进度条 UI，对接 `index:progress` 与长任务提示 | 中 | 已完成 | Renderer 展示进度条+取消按钮，主进程/Worker 支持 `index:cancel` |

### 4. 索引引擎/Worker（FR-2）
| 编号 | 任务 | 描述 | 优先级 | 状态 | 备注 |
| --- | --- | --- | --- | --- | --- |
| W-01 | Worker 启动与通信协议 | 定义与主进程的消息格式，处理初始化/退出/错误场景 | 高 | 已完成 | WorkerManager + Typed IPC 建立，包含错误转发与自动重启策略 |
| W-02 | 动态 Schema 生成 | 解析命名捕获组，创建 `logs`、`logs_fts`、`meta` 表并映射字段类型 | 高 | 已完成 | Worker 引入 SchemaBuilder，按模板动态生成 logs/meta 表结构 |
| W-03 | FTS5 集成 | 为模板指定的全文字段创建 FTS5 虚拟表并建立触发器/同步策略 | 高 | 已完成 | SchemaBuilder 创建 logs_fts FTS5 表并配置 INSERT/UPDATE/DELETE 触发器 |
| W-04 | 流式解析与批量写入 | 通过 `fs.createReadStream` + `readline` 逐行解析，批量事务写入 `better-sqlite3` | 高 | 已完成 | LogIndexer 使用 readline + 批量事务写入 logs/FTS，支持模板字段映射 |
| W-05 | 进度与完成事件 | 定期发送 `index:progress`、在缓存复用或全量索引完成时发送 `index:complete` | 中 | 已完成 | Worker 按 bytesRead 报告进度，支持取消后 `cancelled` 标记，缓存命中即时完成 |
| W-06 | 非匹配行策略 | 对无法匹配 Regex 的行做跳过/标记，并可记录日志供用户检查（NFR-5） | 中 | 已完成 | Worker 统计 `skipped/unmatched` 样本并回传，UI 展示未匹配样本及行数 |
| W-07 | 缓存元数据写入 | 在 `meta` 表中记录 `source_mtime`、模板版本、行数等元信息 | 中 | 已完成 | IndexCacheManager 写入 `source_size/insertedRows/skippedRows` 并在 summary 中返回 |
| W-08 | 错误与取消处理 | 支持用户取消索引，优雅关闭文件流，并向主进程报告错误详情 | 中 | 已完成 | Worker/Renderer 支持 `index:cancel`，记录未匹配样本并通过 UI 提示错误 |

### 5. 查询引擎与数据访问（FR-3）
| 编号 | 任务 | 描述 | 优先级 | 状态 | 备注 |
| --- | --- | --- | --- | --- | --- |
| Q-01 | 查询构建器 | 根据搜索词、结构化过滤、分页、排序动态拼装 SQL，确保索引使用 | 高 | 已完成 | 新增 QueryBuilder + `query:run`，支持 FTS 搜索、过滤、分页计数 |
| Q-02 | 过滤器选项提供 | 针对低基数字段执行 `SELECT DISTINCT` 并缓存结果，供渲染层使用 | 中 | 已完成 | `filters:getOptions` 返回指定列的 DISTINCT 结果，供 UI 构建筛选 |
| Q-03 | `schema:get` 实现 | 返回 PRAGMA `table_info` 结果并抽象为渲染层可用的 `ColumnInfo[]` | 中 | 已完成 | 主进程移除重复 handler，统一读取 table_info + meta 并返回完整列信息 |
| Q-04 | 查询安全 | 预处理列名、限制 limit/offset，阻止 SQL 注入 | 中 | 已完成 | QueryBuilder 增加列白名单、排序校验与 limit/offset 清洗，所有过滤/排序均参数化 |

### 6. 渲染层 UI（FR-3）
| 编号 | 任务 | 描述 | 优先级 | 状态 | 备注 |
| --- | --- | --- | --- | --- | --- |
| R-01 | Pinia 全局状态 | 设计 templates、logs、filters、progress、recentFiles 等 Store | 高 | 已完成 | 新增 logsStore 管理 schema/查询/过滤状态，与模板 store 协同 |
| R-02 | 主界面布局 | 构建多栏布局（顶部工具栏 + 侧边栏 + 主内容），适配深浅色主题 | 中 | 已完成 | 新布局包含 header/状态栅格/工作区，拖拽提示与缓存面板视觉统一 |
| R-03 | 文件导入流程 | 引导用户选择文件→选择模板→触发 `index:start`，并在 UI 中展示所选信息 | 高 | 已完成 | 统一 `handleExternalFileOpen`，索引完成后 logsStore 自动加载 schema/查询 |
| R-04 | 日志列表渲染 | 使用 `vue-virtual-scroller` 虚拟滚动，表头自适应列宽并支持百万行顺滑浏览（FR-3.2/3.3） | 高 | 已完成 | LogViewer 切换 RecycleScroller，滚动区自动触发增量加载 |
ue-virtual-scroller 虚拟滚动，表头自适应列宽并支持百万行顺滑浏览（FR-3.2/3.3） | 高 | 已完成 | LogViewer 切换 RecycleScroller，滚动区自动触发增量加载 |
| R-05 | 日志详情视图 | 选中行展示字段详情，JSON 自动 pretty-print 并支持复制（FR-3.5/3.6） | 中 | 已完成 | 新增右侧详情面板、字段复制按钮、JSON 自动格式化 |
| R-06 | 日志级别高亮 | 将 `level` 字段映射到 ERROR/WARN/INFO 等颜色 | 中 | 已完成 | 行级样式 + level pill，错误/告警高亮清晰，可扩展映射 |
| R-07 | 动态过滤器组件 | 根据 Schema 自动生成低基数字段过滤器并展示选项 | 中 | 已完成 | Pinia Store 推断候选列并获取 options，渲染层联动更新 |
| R-08 | 索引进度与缓存提示 | 展示进度条、缓存命中状态、错误提示及重试入口 | 中 | 已完成 | App 仪表盘新增索引状态芯片、缓存占用列表与刷新/清理动作 |
| R-09 | 最近文件与模板区 | 在 UI 中展示最近记录、允许一键重新打开并说明缓存状态（FR-2.6） | 低 | 已完成 | 最近面板显示模板缺失标记、上次打开时间与快速重开按钮 |

### 7. 运维与设置
| 编号 | 任务 | 描述 | 优先级 | 状态 | 备注 |
| --- | --- | --- | --- | --- | --- |
| S-01 | 索引缓存总览 | 展示 index_cache 占用并提供一键打开缓存目录（NFR-3/4） | 中 | 已完成 | Renderer 显示缓存目录/操作按钮，Main 端提供 openDir IPC |
| S-02 | 可观察性系统日志 | 为主进程/Worker/Renderer 提供统一日志视图，支持刷新 | 中 | 已完成 | 新增 logs:getRecent IPC 与系统日志面板，可配置行数并手动刷新 |
| S-03 | 用户偏好设置 | 持久化主题、查询条数、窗口状态等偏好（S-03） | 中 | 已完成 | 偏好 Store + 面板可即时更新，主进程记忆窗口大小/位置 |

### 8. 测试与质量保障
| 编号 | 任务 | 描述 | 优先级 | 状态 | 备注 |
| --- | --- | --- | --- | --- | --- |
| QA-01 | 单元测试（模板/校验） | 覆盖命名捕获解析、字段校验、配置持久化等关键逻辑 | 中 | 未开始 | |
| QA-02 | Worker 集成测试 | 使用示例日志验证索引、缓存命中/失效、非匹配行策略 | 高 | 未开始 | |
| QA-03 | 查询引擎测试 | 针对全文搜索、组合过滤、分页做回归测试 | 中 | 未开始 | |
| QA-04 | 渲染层组件测试 | 对 Pinia Store、虚拟列表、过滤面板做组件级测试 | 低 | 未开始 | |
| QA-05 | 端到端测试 | 通过 Playwright/ Spectron 等脚本覆盖“打开→索引→搜索→查看详情”流程 | 高 | 未开始 | |
| QA-06 | 性能与内存基准 | 构造 >5GB 日志模拟索引与滚动，验证 CPU/内存占用满足大文件要求 | 高 | 未开始 | |
| QA-07 | 打包冒烟测试 | 在 Windows/macOS/Linux 上验证安装包启动、读取文件、缓存写入 | 中 | 未开始 | |

### 9. 文档与支持
| 编号 | 任务 | 描述 | 优先级 | 状态 | 备注 |
| --- | --- | --- | --- | --- | --- |
| D-01 | 用户指南 | 编写模板创建、正则命名规则、索引缓存管理等使用说明 | 中 | 未开始 | |
| D-02 | 开发者文档 | 补充架构概览、IPC 协议、模块接口，方便后续维护 | 中 | 未开始 | |
| D-03 | 发布与疑难排查 | 制定版本发布清单、常见问题及日志收集办法 | 低 | 未开始 | |
